---
title: "Exploratory Data Analysis and Mapping"
format:
    html:
        code-fold: show
---


## Exploratory Mapping

Mapping these data are easy. Here, the `R` commands below take about 2 minutes to run. To map these data, we'll need to:

1. import data
3. join data
4. map and refine


### Import Data

I use `sf` for most spatial processes, `tidyverse` for general data wrangling, and `tmap` for interactive mapping.

```{r}
library(tidyverse)
library(sf)
library(tmap)
```

Data come from the City of Boston's [open data portal](https://data.boston.gov/dataset?q=property+assessment).

```{r}
parcel_file <- tempfile()
download.file("https://bostonopendata-boston.opendata.arcgis.com/datasets/boston::parcels-2021.geojson", parcel_file)
```

Bringing these files in as `sf` objects will let us manipulate them.
It's important to keep in mind that parcel data for 2022 has not yet been published; I'm using property assessment 2021 data as a result.

```{r}
parcels <- read_sf(parcel_file, quiet = FALSE)
prop_assess <- read_csv("https://data.boston.gov/dataset/e02c44d2-3c64-459c-8fe2-e1ce5f38a035/resource/c4b7331e-e213-45a5-adda-052e4dd31d41/download/data2021-full.csv")
```

## Clean Data

These data are about as clean as can be, but we can do my laptop a service my removing many records.

```{r}
prop_assess <- filter(prop_assess, CITY == 'MATTAPAN')
```


## Join Data

```{r}
property <- parcels %>%
    select(MAP_PAR_ID, geometry) %>%
    inner_join(prop_assess, by = c('MAP_PAR_ID' = 'GIS_ID'))
```

## Render Map

We'll render a view that generates 4 maps, so that parcels can be compared across multiple types of data.

```{r}
tmap_mode('view')
property %>%
  filter(OWN_OCC == 'Y') %>%
  unite('address', c('ST_NUM', 'ST_NAME'), sep = ' ') %>%
  mutate('Year Built (From 1990)' = coalesce(YR_REMODEL, YR_BUILT)-1990) %>%
  tm_shape() +
  tm_fill(c('HEAT_TYPE', 'AC_TYPE', 'Year Built (From 1990)', 'LU_DESC'), id = 'address', popup.vars = c('YR_BUILT', 'HEAT_TYPE', 'AC_TYPE')) +
  tm_facets(nrow = 2, ncol = 2, sync = TRUE) +
  tm_basemap(server = 'OpenStreetMap', alpha = .5) +
  tm_view(bbox = 'Mattapan, Boston')
```

